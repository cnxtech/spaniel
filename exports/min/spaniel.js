!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.spaniel=t.spaniel||{})}(this,function(t){"use strict";function e(t,e){var n=t.boundingClientRect,i=t.intersectionRatio;if(0===n.width||0===n.height){var o=t.boundingClientRect,r=t.intersectionRect;return o.left===r.left&&o.top===r.top&&r.width>=0&&r.height>=0}return i>e||1===i&&1===e}function n(t){try{return t.getBoundingClientRect()}catch(t){if("object"==typeof t&&null!==t&&16389==(65535&t.number))return{top:0,bottom:0,left:0,width:0,height:0,right:0,x:0,y:0};throw t}}function i(){++q.version}function o(){var t=null!=document.scrollingElement;q.getScrollTop=t?function(){return document.scrollingElement.scrollTop}:function(){return window.scrollY},q.getScrollLeft=t?function(){return document.scrollingElement.scrollLeft}:function(){return window.scrollX}}function r(t){return!D&&(D=t,!0)}function s(){return D||(D=new A)}function h(){return W+++M}function u(){return Q||(Q=new V)}function l(){return z||(z={scroll:new F(function(t){var e=this.state,n=e.scrollTop,i=e.scrollLeft;return this.state=t,n!==t.scrollTop||i!==t.scrollLeft}),resize:new F(function(t){var e=this.state,n=e.width,i=e.height;return this.state=t,i!==t.height||n!==t.width}),destroy:new U,beforeunload:new U,hide:new U,show:new U})}function c(t,e){var n=l()[t];n&&n.listen(e)}function a(t,e){if(z){var n=z[t];n&&n.unlisten(e)}}function d(t,e){if(z){var n=z[t];n&&n.trigger(e)}}function p(t){u().scheduleWork(t)}function f(t){u().scheduleRead(t)}function g(t){var e=t.left,n=t.right,i=t.top,o=t.bottom;return{left:e,top:i,bottom:o,right:n,width:n-e,height:o-i}}function y(t){var e=t.split(" ").map(function(t){return parseInt(t,10)});switch(e.length){case 2:return{top:e[0],left:e[1],bottom:e[0],right:e[1]};case 3:return{top:e[0],left:e[1],bottom:e[2],right:e[1]};case 4:return{top:e[0],left:e[1],bottom:e[2],right:e[3]};default:return{top:0,left:0,bottom:0,right:0}}}function b(t){var e=t.time,n=t.rootBounds,i=t.boundingClientRect,o=t.intersectionRect,r=t.target,s=i.height*i.width;return{time:e,rootBounds:n,boundingClientRect:i,intersectionRect:o,target:r,intersectionRatio:s>0?o.width*o.height/s:0}}function v(t,e,n,i){var o=(e.top,e.bottom),r=(e.left,e.right),s={left:t.left+i.left,top:t.top+i.top,bottom:i.bottom,right:i.right,width:t.width-(i.right+i.left),height:t.height-(i.bottom+i.top)},h=Math.max(s.left,e.left),u=Math.max(s.top,e.top),l=Math.min(s.left+s.width,e.right)-h,c=Math.min(s.top+s.height,e.bottom)-u,a={left:l>=0?h:0,top:u>=0?u:0,width:l,height:c,right:r,bottom:o};return b({time:t.timestamp,rootBounds:s,target:n,boundingClientRect:g(e),intersectionRect:a})}function m(t){return t.top+"px "+t.right+"px "+t.bottom+"px "+t.left+"px"}function w(t){t.forEach(function(t){var e=t.label,n=t.duration,i=t.boundingClientRect,o={duration:n,boundingClientRect:i};t.entering?t.payload.callback(e,o):"impressed"===t.label&&(o.visibleTime=t.time-t.duration,t.payload.callback("impression-complete",o))})}function E(t,e){u().queryElement(t,e)}function _(t,n,i,o){void 0===n&&(n=0),void 0===o&&(o={top:0,bottom:0,left:0,right:0}),E(t,function(r,s){var h=v(s,r,t,o);i(e(h,n))})}var R=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),S=function(){function t(){this.items=[]}return t.prototype.remove=function(t){for(var e=this.items.length,n=0;n<e;n++)this.removePredicate(t,this.items[n])&&(this.items.splice(n,1),n--,e--)},t.prototype.clear=function(){this.items=[]},t.prototype.push=function(t){this.items.push(t)},t.prototype.isEmpty=function(){return 0===this.items.length},t}(),T=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return R(e,t),e.prototype.removePredicate=function(t,e){return"string"==typeof t?e.id===t:e.callback===t},e}(S),k=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return R(e,t),e.prototype.removePredicate=function(t,e){return e===t},e}(S),C=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return R(e,t),e.prototype.removePredicate=function(t,e){return"string"==typeof t?e.id===t:"function"==typeof t?e.callback===t:e.el===t},e}(S),L=function(){return 0},x=!("undefined"==typeof window||!window||"undefined"==typeof document||!document),O=x&&!!window.requestAnimationFrame,q={hasDOM:x,hasRAF:O,getScrollTop:L,getScrollLeft:L,getHeight:L,getWidth:L,rAF:O?window.requestAnimationFrame.bind(window):function(t){t()},meta:{width:0,height:0,scrollTop:0,scrollLeft:0,x:0,y:0,top:0,left:0},version:0,lastVersion:0,updateMeta:L,get isDirty(){return q.version!==q.lastVersion}};x&&(q.getHeight=function(){return window.innerHeight},q.getWidth=function(){return window.innerWidth},q.updateMeta=function(){q.meta.height=q.getHeight(),q.meta.width=q.getWidth(),q.meta.scrollLeft=q.getScrollLeft(),q.meta.scrollTop=q.getScrollTop(),q.lastVersion=q.version},q.updateMeta(),"loading"!==document.readyState?o():document.addEventListener("DOMContentLoaded",o),window.addEventListener("resize",i,!1),window.addEventListener("scroll",i,!1));var A=function(){function t(){this.reads=[],this.work=[],this.running=!1}return t.prototype.scheduleRead=function(t){this.reads.unshift(t),this.run()},t.prototype.scheduleWork=function(t){this.work.unshift(t),this.run()},t.prototype.run=function(){var t=this;this.running||(this.running=!0,q.rAF(function(){t.running=!1;for(var e=0,n=t.reads.length;e<n;e++)t.reads.pop()();for(var e=0,i=t.work.length;e<i;e++)t.work.pop()();(t.work.length>0||t.reads.length>0)&&t.run()}))},t}(),D=null,H=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),M="xxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}),W=0,I=function(){function t(t,e,n,i,o,r,s,h,u){this.timestamp=t,this.scrollTop=e,this.scrollLeft=n,this.width=i,this.height=o,this.x=r,this.y=s,this.top=h,this.left=u}return t.generate=function(e){void 0===e&&(e=window);var n=this.revalidateRootMeta(e);return new t(Date.now(),n.scrollTop,n.scrollLeft,n.width,n.height,n.x,n.y,n.top,n.left)},t.revalidateRootMeta=function(t){void 0===t&&(t=window);var e=null,i={width:0,height:0,scrollTop:0,scrollLeft:0,x:0,y:0,top:0,left:0};return q.isDirty&&q.updateMeta(),t===window?(i.height=q.meta.height,i.width=q.meta.width,i.scrollLeft=q.meta.scrollLeft,i.scrollTop=q.meta.scrollTop,i):(e=n(t),i.scrollTop=t.scrollTop,i.scrollLeft=t.scrollLeft,i.width=e.width,i.height=e.height,i.x=e.x,i.y=e.y,i.top=e.top,i.left=e.left,i)},t}(),j=function(){function t(t,e){void 0===e&&(e=window),this.isTicking=!1,this.toRemove=[],this.engine=t||s(),this.root=e}return t.prototype.tick=function(){if(this.queue.isEmpty())this.isTicking=!1;else{if(this.toRemove.length>0){for(var t=0;t<this.toRemove.length;t++)this.queue.remove(this.toRemove[t]);this.toRemove=[]}this.applyQueue(I.generate(this.root)),this.engine.scheduleRead(this.tick.bind(this))}},t.prototype.scheduleWork=function(t){this.engine.scheduleWork(t)},t.prototype.scheduleRead=function(t){this.engine.scheduleRead(t)},t.prototype.queryElement=function(t,e){var i=this,o=null,r=null;this.engine.scheduleRead(function(){o=n(t),r=I.generate(i.root)}),this.engine.scheduleWork(function(){e(o,r)})},t.prototype.unwatch=function(t){this.toRemove.push(t)},t.prototype.unwatchAll=function(){this.queue.clear()},t.prototype.startTicking=function(){this.isTicking||(this.isTicking=!0,this.engine.scheduleRead(this.tick.bind(this)))},t}(),V=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.queue=new T,e}return H(e,t),e.prototype.applyQueue=function(t){for(var e=0;e<this.queue.items.length;e++){var n=this.queue.items[e],i=n.id;(0,n.callback)(t,i)}},e.prototype.watch=function(t){this.startTicking();var e=h();return this.queue.push({callback:t,id:e}),e},e}(j),P=function(t){function e(e){var n=t.call(this,null,window)||this;return n.predicate=e,n}return H(e,t),e.prototype.applyQueue=function(e){this.predicate(e)&&t.prototype.applyQueue.call(this,e)},e}(V),B=function(t){function e(e,n,i){void 0===i&&(i=!1);var o=t.call(this,e,n)||this;return o.lastVersion=q.version,o.queue=new C,o.ALLOW_CACHED_SCHEDULER=i,o}return H(e,t),Object.defineProperty(e.prototype,"isDirty",{get:function(){return q.version!==this.lastVersion},enumerable:!0,configurable:!0}),e.prototype.applyQueue=function(t){for(var e=0;e<this.queue.items.length;e++){var i=this.queue.items[e],o=i.callback,r=i.el,s=i.id,h=i.clientRect;!this.isDirty&&h&&this.ALLOW_CACHED_SCHEDULER||(h=this.queue.items[e].clientRect=n(r)),o(t,s,h)}this.lastVersion=q.version},e.prototype.watch=function(t,e,n){this.startTicking(),n=n||h();return this.queue.push({el:t,callback:e,id:n,clientRect:null}),n},e}(j),Q=null,U=function(){function t(){this.queue=new k}return t.prototype.listen=function(t){this.queue.push(t)},t.prototype.unlisten=function(t){this.queue.remove(t)},t.prototype.trigger=function(t){for(var e=0;e<this.queue.items.length;e++)this.queue.items[e](t)},t}(),F=function(){function t(t){this.scheduler=new P(t.bind(this))}return t.prototype.trigger=function(t){},t.prototype.listen=function(t){this.state=I.generate(),this.scheduler.watch(t)},t.prototype.unlisten=function(t){this.scheduler.unwatch(t)},t}(),z=null;q.hasDOM&&(window.addEventListener("beforeunload",function(t){d("beforeunload"),d("destroy")}),document.addEventListener("visibilitychange",function(){d("visible"===document.visibilityState?"show":"hide")}));var G=function(){function t(t,e){void 0===e&&(e={}),this.records={},this.callback=t,this.id=h(),e.threshold=e.threshold||0,this.rootMarginObj=y(e.rootMargin||"0px"),this.root=e.root,Array.isArray(e.threshold)?this.thresholds=e.threshold:this.thresholds=[e.threshold],this.scheduler=new B(null,this.root,e.ALLOW_CACHED_SCHEDULER)}return t.prototype.observe=function(t){var e=this,n=t,i=n.__spanielId=n.__spanielId||h();return this.scheduler.watch(t,function(t,i,o){e.onTick(t,i,o,n)},n.__spanielId),i},t.prototype.onTick=function(t,e,n,i){var o=this,r=this.generateEntryEvent(t,n,i),s=r.numSatisfiedThresholds,h=r.entry,u=this.records[e]||(this.records[e]={entry:h,numSatisfiedThresholds:0});s!==u.numSatisfiedThresholds&&(u.numSatisfiedThresholds=s,this.scheduler.scheduleWork(function(){o.callback([h])}))},t.prototype.unobserve=function(t){this.scheduler.unwatch(t.__spanielId),delete this.records[t.__spanielId]},t.prototype.disconnect=function(){this.scheduler.unwatchAll(),this.records={}},t.prototype.takeRecords=function(){return[]},t.prototype.generateEntryEvent=function(t,n,i){for(var o=0,r=v(t,n,i,this.rootMarginObj),s=(r.intersectionRatio,0);s<this.thresholds.length;s++){e(r,this.thresholds[s])&&o++}return{numSatisfiedThresholds:o,entry:r}},t}(),N={x:0,y:0,width:0,height:0},X=function(){function t(t,e){void 0===e&&(e={});var n=this;this.paused=!1,this.queuedEntries=[],this.recordStore={},this.callback=t;var i=e.root,o=e.rootMargin,r=e.threshold,s=e.ALLOW_CACHED_SCHEDULER;o=o||"0px";var h="string"!=typeof o?m(o):o;this.thresholds=r.sort(function(t){return t.ratio});var u={root:i,rootMargin:h,threshold:this.thresholds.map(function(t){return t.ratio}),ALLOW_CACHED_SCHEDULER:s};this.observer=new G(function(t){return n.internalCallback(t)},u),this.onTabHidden=this._onTabHidden.bind(this),this.onWindowClosed=this._onWindowClosed.bind(this),this.onTabShown=this._onTabShown.bind(this),q.hasDOM&&(c("beforeunload",this.onWindowClosed),c("hide",this.onTabHidden),c("show",this.onTabShown))}return t.prototype._onWindowClosed=function(){this.onTabHidden()},t.prototype.setAllHidden=function(){for(var t=Object.keys(this.recordStore),e=Date.now(),n=0;n<t.length;n++)this.handleRecordExiting(this.recordStore[t[n]],e);this.flushQueuedEntries()},t.prototype._onTabHidden=function(){this.paused=!0,this.setAllHidden()},t.prototype._onTabShown=function(){this.paused=!1;for(var t=Object.keys(this.recordStore),e=Date.now(),n=0;n<t.length;n++){var i=this.recordStore[t[n]].lastSeenEntry;if(i){var o=i.intersectionRatio,r=i.boundingClientRect,s=i.rootBounds,h=i.intersectionRect,u=i.target;this.handleObserverEntry({intersectionRatio:o,boundingClientRect:r,time:e,rootBounds:s,intersectionRect:h,target:u})}}},t.prototype.internalCallback=function(t){t.forEach(this.handleObserverEntry.bind(this))},t.prototype.flushQueuedEntries=function(){this.queuedEntries.length>0&&(this.callback(this.queuedEntries),this.queuedEntries=[])},t.prototype.generateSpanielEntry=function(t,e){var n=t.intersectionRatio,i=t.time,o=t.rootBounds,r=t.boundingClientRect,s=t.intersectionRect,h=t.target;return{intersectionRatio:n,time:i,rootBounds:o,boundingClientRect:r,intersectionRect:s,target:h,duration:0,entering:null,payload:this.recordStore[h.__spanielId].payload,label:e.threshold.label}},t.prototype.handleRecordExiting=function(t,e){var n=this;void 0===e&&(e=Date.now()),t.thresholdStates.forEach(function(i){n.handleThresholdExiting({intersectionRatio:-1,time:e,payload:t.payload,label:i.threshold.label,entering:!1,rootBounds:N,boundingClientRect:N,intersectionRect:N,duration:e-i.lastVisible,target:t.target},i),i.lastSatisfied=!1,i.visible=!1,i.lastEntry=null})},t.prototype.handleThresholdExiting=function(t,e){var n=t.time,i=(t.intersectionRatio,!!e.threshold.time);e.lastSatisfied&&(!i||i&&e.visible)&&(t.duration=n-e.lastVisible,t.entering=!1,e.visible=!1,this.queuedEntries.push(t)),clearTimeout(e.timeoutId)},t.prototype.handleObserverEntry=function(t){var n=this,i=t.time,o=t.target,r=this.recordStore[o.__spanielId];r.lastSeenEntry=t,this.paused||(r.thresholdStates.forEach(function(o){var r=!!o.threshold.time,s=n.generateSpanielEntry(t,o),h=e(t,o.threshold.ratio);if(h&&!o.lastSatisfied)if(s.entering=!0,r){o.lastVisible=i;var u=Number(setTimeout(function(){o.visible=!0,s.duration=Date.now()-o.lastVisible,n.callback([s])},o.threshold.time));o.timeoutId=u}else o.visible=!0,n.queuedEntries.push(s);else h||n.handleThresholdExiting(s,o);o.lastEntry=t,o.lastSatisfied=h}),this.flushQueuedEntries())},t.prototype.disconnect=function(){this.setAllHidden(),this.observer.disconnect(),this.recordStore={}},t.prototype.destroy=function(){this.disconnect(),q.hasDOM&&(a("beforeunload",this.onWindowClosed),a("hide",this.onTabHidden),a("show",this.onTabShown))},t.prototype.unobserve=function(t){var e=this,n=this.recordStore[t.__spanielId];n&&(delete this.recordStore[t.__spanielId],this.observer.unobserve(t),p(function(){e.handleRecordExiting(n),e.flushQueuedEntries()}))},t.prototype.observe=function(t,e){void 0===e&&(e=null);var n=t,i=n.__spanielId=n.__spanielId||h();return this.recordStore[i]={target:n,payload:e,lastSeenEntry:null,thresholdStates:this.thresholds.map(function(t){return{lastSatisfied:!1,lastEntry:null,threshold:t,visible:!1,lastVisible:null}})},this.observer.observe(n),i},t}(),Y=function(){function t(t){void 0===t&&(t={});var e=t.time,n=t.ratio,i=t.rootMargin,o=t.root,r=t.ALLOW_CACHED_SCHEDULER,s=[{label:"exposed",time:0,ratio:0}];e&&s.push({label:"impressed",time:e,ratio:n||0}),n&&s.push({label:"visible",time:0,ratio:n}),this.observer=new X(w,{rootMargin:i,threshold:s,root:o,ALLOW_CACHED_SCHEDULER:r})}return t.prototype.watch=function(t,e){this.observer.observe(t,{callback:e})},t.prototype.unwatch=function(t){this.observer.unobserve(t)},t.prototype.disconnect=function(){this.observer.disconnect()},t.prototype.destroy=function(){this.observer.destroy()},t}();t.on=c,t.off=a,t.scheduleRead=f,t.scheduleWork=p,t.IntersectionObserver=G,t.SpanielObserver=X,t.setGlobalEngine=r,t.getGlobalEngine=s,t.__w__=q,t.invalidate=i,t.queryElement=E,t.elementSatisfiesRatio=_,t.Watcher=Y,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=spaniel.map